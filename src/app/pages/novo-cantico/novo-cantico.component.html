<ion-header [translucent]="false" class="ion-no-border" mode="ios">

  <ion-toolbar class="ion-no-border" color="primary">
    <ion-buttons slot="start">
      <ion-menu-button color="light"></ion-menu-button>
    </ion-buttons>
    <ion-title color="light">novo cântico</ion-title>
    <ion-buttons slot="end">
      <ion-button id="open-favorites-modalh" expand="block" color="danger">
        <ion-icon slot="icon-only" [name]="modalFavorites.isCmpOpen ? 'heart' : 'heart-outline'"></ion-icon>
      </ion-button>
    </ion-buttons>

  </ion-toolbar>

  <ion-toolbar color="primary" class="ion-no-border grid-search">
    <ion-searchbar
      class="custom"
      color="light"
      placeholder="procurar hino"
      animated="true"
      [debounce]="1000"
      [(ngModel)]="searchBarTerm"
      (ionChange)="searchBar()">
    </ion-searchbar>

    <ion-modal #modalIndice class="modal-indice" trigger="open-indice-modalh">
      <ng-template>
        <ion-header class="ion-no-border" mode="ios">
          <ion-toolbar>
            <ion-buttons slot="start">
              <ion-button size="small" fill="clear" (click)="modalIndice.dismiss()">
                <ion-icon name="arrow-back-outline" slot="icon-only" color="primary"></ion-icon>
              </ion-button>
            </ion-buttons>
            <ion-title color="primary">Temáticas e Assuntos</ion-title>
          </ion-toolbar>
        </ion-header>

        <ion-content [fullscreen]="true" class="ion-padding">
          <ion-accordion-group>
            <ion-accordion *ngFor="let tematica of tematicas" [value]="tematica.title">
              <ion-item slot="header" color="light">
                <ion-label color="primary">
                  <h2>{{ tematica.title }}</h2>
                  <ion-note>Total de {{ tematica.quantity === 1 ? 'apenas' : '' }} <ion-text color="tertiary">{{ tematica.quantity }}</ion-text> {{ tematica.quantity === 1 ? 'hino o ' : tematica.quantity === 2 ? 'hinos': 'hinos do' }} {{ tematica.range }}</ion-note>
                </ion-label>
              </ion-item>
              <ion-item *ngFor="let assunto of tematica.assunto"
                class="ion-padding-start" button detail="true" slot="content" color="light"
                (click)="searchFilterTematicaAndAssunto(assunto.title); modalIndice.dismiss()">
                <ion-label color="secondary">
                  <p>{{ assunto.title }}</p>
                  <ion-note>Total de {{ assunto.quantity === 1 ? 'apenas' : '' }} <ion-text color="tertiary">{{ assunto.quantity }}</ion-text> {{ assunto.quantity === 1 ? 'hino o ' : assunto.quantity === 2 ? 'hinos': 'hinos do' }} {{ assunto.range }}</ion-note>
                </ion-label>
              </ion-item>
            </ion-accordion>
          </ion-accordion-group>
        </ion-content>

        <ion-footer class="ion-no-border" mode="ios">
          <ion-toolbar class="ion-text-center">
            <ion-note>Hinário Novo Cântico</ion-note>
          </ion-toolbar>
        </ion-footer>
      </ng-template>
    </ion-modal>
  </ion-toolbar>

  <ion-toolbar color="primary" class="ion-no-border grid-searchkeys">
    <ion-grid>
      <ion-row class="searchkeys">
        <ng-container *ngIf="hinosStorage && hinosStorage.searchFilter.length">
          <ion-col class="ion-no-padding" *ngFor="let keyword of hinosStorage.searchFilter; index as i" size="auto">
            <ion-chip
              (click)="searchFilter(keyword.name, i)" class="ion-no-margin-top"
              button [color]="keyword.active ? 'secondary' : 'light'" [outline]="true">
                {{ keyword.name }}
            </ion-chip>
          </ion-col>
        </ng-container>

        <ion-col class="add-new-filter">
          <ion-chip
            id="open-newFilter-dialogh" expand="block"
            button color="light" [outline]="false">
              <ion-icon color="light" [name]="popoverFilters.isCmpOpen ? 'funnel' : 'funnel-outline'"></ion-icon>
          </ion-chip>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-toolbar>

  <ion-toolbar color="primary" class="ion-no-border grid-recentes">
    <ng-container *ngIf="hinosStorage && hinosStorage.recents.length">
      <ion-grid>
        <ion-row class="title-recentes">
          <ion-note class="ion-padding ion-font-small" color="light">últimos visualizados</ion-note>
        </ion-row>
        <ion-row class="recentes">
          <ion-col *ngFor="let hino of hinosStorage.recents">
            <ion-chip
              (click)="selected(hino)"
              button color="light" [outline]="false">
                {{ hino.numero }}
            </ion-chip>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ng-container>
  </ion-toolbar>

  <ion-toolbar color="primary" class="ion-no-border grid-note">
    <ng-container *ngIf="hinosSearch$ | async">
      <ion-note color="light" slot="end" class="ion-no-padding">
        {{ (hinosSearch$ | async)?.length + ' encontrado'}}{{ ((hinosSearch$ | async)?.length === 1) ? ''  : 's' }}
      </ion-note>
      <ion-button size="small" fill="clear" (click)="clearSearch()" slot="end">
        <ion-icon size="small" name="trash-outline" slot="icon-only" color="danger"></ion-icon>
      </ion-button>
    </ng-container>
  </ion-toolbar>

  <svg
    style="margin-top: -1px;"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 1440 320">
    <path
      fill="#005B40"
      fill-opacity="1"
      d="M0,32L20,32C40,32,80,32,120,48C160,64,200,96,240,106.7C280,117,320,107,360,117.3C400,128,440,160,480,197.3C520,235,560,277,600,256C640,235,680,149,720,133.3C760,117,800,171,840,165.3C880,160,920,96,960,69.3C1000,43,1040,53,1080,80C1120,107,1160,149,1200,149.3C1240,149,1280,107,1320,85.3C1360,64,1400,64,1420,64L1440,64L1440,0L1420,0C1400,0,1360,0,1320,0C1280,0,1240,0,1200,0C1160,0,1120,0,1080,0C1040,0,1000,0,960,0C920,0,880,0,840,0C800,0,760,0,720,0C680,0,640,0,600,0C560,0,520,0,480,0C440,0,400,0,360,0C320,0,280,0,240,0C200,0,160,0,120,0C80,0,40,0,20,0L0,0Z">
    </path>
  </svg>
</ion-header>

<ion-content [fullscreen]="true">
  <ng-container *ngIf="hinosSearch$ | async; else noHino">
    <ion-virtual-scroll [items]="hinosSearch$ | async">
      <ion-item-sliding
          *virtualItem="let hino"
          style="
            border-right: 5px solid var(--ion-color-success);
            border-radius: 10px;
          "
          button
          (ionDrag)="addInArrayStorage('favorites', hino, 'numero', $event)"
          (click)="selected(hino)">

        <ion-item
          lines="inset"
          detail="true"
          detail-icon="add-outline">
          <ion-chip slot="start" color="success" [outline]="true">{{ hino.numero }}</ion-chip>
          <ion-label>
            <ion-note class="ion-font-smaller">{{hino.tematica + " ・ " + hino.assunto}}</ion-note>
            <ion-text color="primary"><h2>{{ hino.titulo }}</h2></ion-text>
            <ion-note>{{ hino.autor }}</ion-note>
          </ion-label>
        </ion-item>

        <ion-item-options side="end">
          <ion-item-option color="success" expandable>
            <ion-text color="light">favoritar</ion-text>
            <ion-icon size="large" slot="end" color="light" name="heart-outline"></ion-icon>
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
    </ion-virtual-scroll>
  </ng-container>

  <ng-template #noHino>
    <ion-grid class="message-logo">
      <ion-row class="ion-padding">
        <img src="../../../assets/logo_lazy.png" alt="logo">
      </ion-row>
      <ion-row class="ion-padding">
        <ion-text color="medium-tint">
          <small>procure pelo <b>número</b>, <b>título</b> ou <b>letra</b> do hino.</small>
        </ion-text>
      </ion-row>
    </ion-grid>
  </ng-template>

  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button id="open-indice-modalh" expand="block" color="tertiary">
      <ion-icon name="search-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>



<!-- modais -->
<ion-popover #popoverFilters trigger="open-newFilter-dialogh" mode="ios"  class="popover-filter">
  <ng-template>
    <ion-header class="ion-no-border" mode="ios">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button size="small" fill="clear" (click)="popoverFilters.dismiss()">
            <ion-icon name="arrow-back-outline" slot="icon-only" color="primary"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title color="primary">palavras chaves</ion-title>
        <ion-buttons slot="end">
          <ion-button size="small" fill="clear" (click)="removeAllInArrayStorage('searchFilter')">
            <ion-icon name="trash-outline" slot="icon-only" color="danger"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
      <ion-toolbar color="light">
        <ion-searchbar
          #ionInputEl
          class="custom"
          color="primary-contrast"
          search-icon="add-circle-outline"
          clear-icon="close-circle-outline"
          placeholder="adicionar novo filtro"
          animated="true"
          autocomplete="on"
          autocorrect="on"
          autocapitalize="on"
          [spellcheck]="true"
          [inputmode]="'text'"
          [enterkeyhint]="'enter'"
          [debounce]="2500"
          [(ngModel)]="keyWordsName"
          (ionChange)="addInSearchFilter()"
          (ionInput)="onInputSearchFilter($event)"
          (keyup.enter)="addInSearchFilter()"
          (keydown.enter)="addInSearchFilter()">
        </ion-searchbar>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <ng-container *ngIf="hinosStorage && hinosStorage.searchFilter.length; else noKeys">
        <ion-list
          class="ion-padding">
          <ion-item-sliding
            *ngFor="let keyword of hinosStorage.searchFilter"
            (ionDrag)="removeInArrayStorage('searchFilter', keyword, 'name', $event)">

            <ion-item
              style="
                border-right: 5px solid var(--ion-color-danger);
                border-radius: 10px;
              "
              lines="full"
              detail="true"
              detail-icon="add-outline">
              <ion-text>{{ keyword.name }}</ion-text>
            </ion-item>

            <ion-item-options side="end">
              <ion-item-option color="danger" expandable>
                <ion-text color="light">apagar</ion-text>
                <ion-icon slot="icon-only" color="light" name="trash-bin-outline"></ion-icon>
              </ion-item-option>
            </ion-item-options>
          </ion-item-sliding>
        </ion-list>
      </ng-container>

      <ng-template #noKeys>
        <ion-grid class="message-logo">
          <ion-row class="ion-padding">
            <img src="../../../assets/filter.svg" alt="logo">
          </ion-row>
          <ion-row class="ion-padding">
            <ion-text color="medium">
              <small>adicione um novo filtro com <br><b>palavras chaves</b>, <b>títulos</b> ou <b>frases</b> do hino.</small>
            </ion-text>
          </ion-row>
        </ion-grid>
      </ng-template>
    </ion-content>
  </ng-template>
</ion-popover>


<ion-modal #modalDetails [isOpen]="isOpenDetailsModal">
  <ng-template>
    <ion-header [translucent]="false" class="ion-no-border" mode="ios">
      <ion-toolbar color="primary" style="--min-height: 60px;">
        <ion-buttons slot="start">
          <ion-button fill="clear" (click)="modalDetails.dismiss(); isOpenDetailsModal = false">
            <ion-icon slot="icon-only" name="arrow-back-outline" color="light"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title color="light">{{ hino.numero + ' ∙ ' + hino.titulo }}</ion-title>
        <ion-buttons slot="end">
          <ion-button fill="clear" (click)="changeBackgroundDarkColor()">
            <ion-icon
              slot="icon-only"
              [name]="this.hinosStorage.formatacao.backgrond ? 'sunny' : 'moon'"
              [color]="this.hinosStorage.formatacao.backgrond ? 'warning' : 'light'"></ion-icon>
          </ion-button>
          <ion-button fill="clear" (click)="presentActionSheet(hino)">
            <ion-icon slot="icon-only" name="ellipsis-vertical-outline" color="light"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
      <ion-toolbar color="primary-contrast" class="toolbar-fab">
        <ion-title size="small">
          <ion-note>{{hino.autor}}</ion-note>
        </ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content [fullscreen]="true" class="ion-padding" [color]="this.hinosStorage.formatacao.backgrond ? 'dark' : 'light'">
      <ion-fab slot="fixed" vertical="top" horizontal="end" [edge]="true">
        <ion-fab-button size="small" color="danger" id="open-zoom-dialogh" expand="block">
          <ion-icon size="small"  name="brush-outline" color="light"></ion-icon>
        </ion-fab-button>
      </ion-fab>
      <ion-text class="hino-letra" [innerText]="hino.letra"></ion-text>
    </ion-content>

    <ion-popover trigger="open-zoom-dialogh" mode="ios" translucent="true">
      <ng-template>
        <ion-content class="ion-padding">
          <ion-grid>
            <ion-row>
              <ion-col>
                <ion-label class="ion-font-small" color="primary">Fonte</ion-label>
              </ion-col>
              <ion-col size="auto">
                <ion-label class="ion-font-small" color="secondary">{{ hinosStorage.formatacao.fonte }}</ion-label>
              </ion-col>
            </ion-row>
            <ion-row class="fontes">
              <ion-col *ngFor="let font of arrayFonts">
                <ion-chip
                  class="font-picker ion-align-items-start ion-no-margin"
                  [color]="hinosStorage.formatacao.fonte === font.value ? 'primary' : 'light'"
                  button
                  (click)="changeFontFamily(font.value)">
                  <ion-text color="secondary" class="ion-font-small ion-margin-bottom">{{ font.title }}</ion-text>
                  <ion-text color="dark" class="ion-no-padding ion-font-smaller" [style.font-family]="font.value">Novo Cântico</ion-text>
                </ion-chip>
              </ion-col>
            </ion-row>
            <ion-row>
              <ion-col size="4">
                <ion-chip color="light" class="font-weight-picker" (click)="changeFontWeight();">
                  <ion-text color="dark" [style.font-weight]="hinosStorage.formatacao.weight ? 'bold' : 'normal'">Negrito</ion-text>
                </ion-chip>
              </ion-col>
              <ion-col size="4">
                <ion-chip color="light" class="font-weight-picker" (click)="changeFontStyle()">
                  <ion-text color="dark" [style.font-style]="hinosStorage.formatacao.style ? 'italic' : 'normal'">Itálico</ion-text>
                </ion-chip>
              </ion-col>
            </ion-row>

            <ion-row class="ion-margin-top">
              <ion-col>
                <ion-label class="ion-font-small" color="primary">Tamanho da Fonte</ion-label>
              </ion-col>
              <ion-col size="auto">
                <ion-label class="ion-font-small" color="secondary">{{ hinosStorage.formatacao.tamanhoFonte }}px</ion-label>
              </ion-col>
            </ion-row>
            <ion-row>
              <ion-col>
                <ion-range mode="md" class="ion-no-padding"
                  (ionKnobMoveStart)="zooming($event)"
                  (ionKnobMoveEnd)="zooming($event)"
                  [min]="10" [max]="40"
                  [value]="hinosStorage.formatacao.tamanhoFonte"
                  [pin]="true"
                  [snaps]="true"
                  [pinFormatter]="pinFormatter">
                  <ion-icon slot="start" size="small" color="secondary" name="text-outline"></ion-icon>
                  <ion-icon slot="end"  color="primary" name="text-outline"></ion-icon>
                </ion-range>
              </ion-col>
            </ion-row>

            <ion-row class="ion-margin-top">
              <ion-col>
                <ion-label class="ion-font-small" color="primary">Cor da Fonte</ion-label>
              </ion-col>
              <ion-col size="auto">
                <ion-icon size="small" color="primary" name="color-palette-outline"></ion-icon>
              </ion-col>
            </ion-row>
            <ion-row class="colors">
              <ion-col *ngFor="let color of arrayColors">
                <div button
                  (click)="changeColor(color)"
                  class="color-picker {{ hinosStorage.formatacao.corFonte === color ? 'active' : '' }}"
                  [style.background-color]="color">
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-content>
      </ng-template>
    </ion-popover>
  </ng-template>
</ion-modal>

<ion-modal
  trigger="open-favorites-modalh"
  #modalFavorites
  [initialBreakpoint]="0.25"
  handleBehavior="cycle"
  [breakpoints]="[0, 0.25, 0.5, 0.75]">

  <ng-template>
    <ion-header [translucent]="true" class="ion-no-border">
      <ion-toolbar>
        <ion-title>Favoritos</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <ion-header collapse="condense">
        <ion-toolbar>
          <ion-title size="large">Favoritos</ion-title>
        </ion-toolbar>
      </ion-header>

      <ng-container *ngIf="hinosStorage && hinosStorage.favorites.length; else noFavoritos">
        <ion-virtual-scroll [items]="hinosStorage.favorites">
          <ion-item-sliding
            *virtualItem="let hino"
            (ionDrag)="removeInArrayStorage('favorites', hino, 'numero', $event)"
            (click)="selected(hino)">

            <ion-item
              style="
                border-right: 5px solid var(--ion-color-danger);
                border-radius: 10px;
              "
              lines="inset"
              detail="true"
              detail-icon="add-outline">

              <ion-chip
                slot="start"
                color="success"
                [outline]="true">
                  {{ hino.numero }}
              </ion-chip>

              <ion-label>
                <ion-note class="ion-font-smaller">{{hino.tematica + " ・ " + hino.assunto}}</ion-note>
                <ion-text color="primary"><h2>{{ hino.titulo }}</h2></ion-text>
                <ion-note>{{ hino.autor }}</ion-note>
              </ion-label>
            </ion-item>

            <ion-item-options side="end">
              <ion-item-option color="danger" expandable>
                <ion-text color="light">desfavoritar</ion-text>
                <ion-icon size="large" slot="end" color="light" name="heart-dislike-outline"></ion-icon>
              </ion-item-option>
            </ion-item-options>
          </ion-item-sliding>
        </ion-virtual-scroll>
      </ng-container>

      <ng-template #noFavoritos>
        <ion-grid class="message-logo">
          <ion-row class="ion-padding">
            <img class="no-img" src="../../../assets/eading_time.svg" alt="logo">
          </ion-row>
          <ion-row class="ion-padding">
            <ion-text color="medium">
              <small>ainda não foram adicionados hinos aos favoritos</small>
            </ion-text>
          </ion-row>
        </ion-grid>
      </ng-template>

    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal
  #modalPDF
  [isOpen]="isOpenPDFModal">
  <ng-template>
    <ion-header [translucent]="true" class="ion-no-border">
      <ion-toolbar>
        <ion-title color="primary">Partitura</ion-title>
        <ion-buttons slot="end">
            <ion-button fill="clear" (click)="modalPDF.dismiss(); isOpenPDFModal = false">
              <ion-icon slot="icon-only" name="close-outline" color="primary"></ion-icon>
            </ion-button>
          </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content [fullscreen]="true">
      <pdf-viewer
        [src]="partitura"
        [external-link-target]="'blank'"
        [render-text]="true"
        [autoresize]="true"
        [show-all]="true"
        [original-size]="false">
      </pdf-viewer>
    </ion-content>
  </ng-template>
</ion-modal>
